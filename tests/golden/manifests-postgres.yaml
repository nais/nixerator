apiVersion: apps/v1
kind: Deployment
metadata:
  annotations: {}
  labels: {}
  name: pgdemo
  namespace: default
spec:
  replicas: 1
  selector:
    matchLabels:
      app: pgdemo
  strategy:
    type: RollingUpdate
  template:
    metadata:
      labels:
        app: pgdemo
    spec:
      containers:
        - env:
            - name: PGHOST
              value: pgdemo-pooler.pg-default
            - name: PGPORT
              value: "5432"
            - name: PGDATABASE
              value: app
            - name: PGUSER
              valueFrom:
                secretKeyRef:
                  key: username
                  name: app-owner-user.pgdemo.credentials.postgresql.acid.zalan.do
            - name: PGPASSWORD
              valueFrom:
                secretKeyRef:
                  key: password
                  name: app-owner-user.pgdemo.credentials.postgresql.acid.zalan.do
            - name: PGURL
              value: postgresql://$(PGUSER):$(PGPASSWORD)@pgdemo-pooler.pg-default:5432/app
            - name: PGJDBCURL
              value: jdbc:postgresql://pgdemo-pooler.pg-default:5432/app?user=$(PGUSER)&password=$(PGPASSWORD)
          image: nginx:1.25
          name: pgdemo
          ports:
            - containerPort: 8080
              name: http
---
apiVersion: v1
kind: Service
metadata:
  annotations: {}
  labels: {}
  name: pgdemo
  namespace: default
spec:
  ports:
    - name: http
      port: 80
      targetPort: 8080
  selector:
    app: pgdemo
  type: ClusterIP
---
apiVersion: acid.zalan.do/v1
kind: postgresql
metadata:
  labels:
    apiserver-access: enabled
  name: pgdemo
  namespace: pg-default
spec:
  connectionPooler:
    resources:
      resourceRequests:
        cpu: 50m
        memory: 50Mi
  enableConnectionPooler: true
  enableReplicaConnectionPooler: false
  nodeAffinity:
    requiredDuringSchedulingIgnoredDuringExecution:
      nodeSelectorTerms:
        - matchExpressions:
            - key: nais.io/type
              operator: In
              values:
                - postgres
  numberOfInstances: 2
  patroni:
    initdb:
      encoding: UTF8
      locale: en_US.UTF-8
    synchronousMode: true
    synchronousModeStrict: true
  postgresql:
    parameters:
      log_destination: jsonlog
      log_filename: postgresql.log
      shared_preload_libraries: bg_mon,pg_stat_statements,pgextwlist,pg_auth_mon,set_user,timescaledb,pg_cron,pg_stat_kcache,pgaudit
    version: "14"
  preparedDatabases:
    app:
      defaultUsers: true
      extensions:
        pgaudit: public
      preparedSchemas:
        public: {}
      secretNamespace: default
  resources:
    resourceLimits:
      cpu: 500m
      memory: 512Mi
    resourceRequests:
      cpu: 500m
      memory: 512Mi
  spiloFSGroup: 103
  spiloRunAsGroup: 103
  spiloRunAsUser: 101
  teamId: default
