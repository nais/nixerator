apiVersion: apps/v1
kind: Deployment
metadata:
  annotations: {}
  labels: {}
  name: vault-paths
  namespace: default
spec:
  replicas: 1
  selector:
    matchLabels:
      app: vault-paths
  strategy:
    type: RollingUpdate
  template:
    metadata:
      labels:
        app: vault-paths
    spec:
      containers:
        - image: nginx:1.25
          name: vault-paths
          ports:
            - containerPort: 8080
              name: http
      initContainers:
        - args:
            - -v=10
            - -logtostderr
            - -one-shot
            - -vault=https://vault.adeo.no
            - -save-token=/var/run/secrets/nais.io/vault/vault_token
            - -cn=secret:/kv/preprod/fss/vault-paths/default:dir=/var/run/secrets/nais.io/vault,fmt=flatten,retries=1
            - -cn=secret:/serviceuser/data/test/srvuser:dir=/secrets/credential/srvuser,fmt=flatten,retries=1
          env:
            - name: VAULT_AUTH_METHOD
              value: kubernetes
            - name: VAULT_SIDEKICK_ROLE
              value: vault-paths
            - name: VAULT_K8S_LOGIN_PATH
              value: auth/kubernetes/preprod/fss/login
          image: navikt/vault-sidekick:v0.3.10-d122b16
          name: vks-init
          volumeMounts:
            - mountPath: /var/run/secrets/nais.io/vault
              name: vault-volume
              subPath: vault/var/run/secrets/nais.io/vault
            - mountPath: /secrets/credential/srvuser
              name: vault-volume
              subPath: vault/secrets/credential/srvuser
---
apiVersion: v1
kind: Service
metadata:
  annotations: {}
  labels: {}
  name: vault-paths
  namespace: default
spec:
  ports:
    - name: http
      port: 80
      targetPort: 8080
  selector:
    app: vault-paths
  type: ClusterIP
